<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="Free personal salary tracker app. Manage monthly income, expenses, balances in EUR/BGN with secure client-side storage. No signup required.">
  <meta name="keywords" content="salary tracker, expense tracker, budget app, personal finance, monthly budget, income expense manager, EUR to BGN, financial tracker">
  <meta name="author" content="Salary Tracker">
  <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
  <meta name="application-name" content="Salary Tracker">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#0d0d18">
  <meta property="og:title" content="Salary Tracker - Free Personal Finance Manager">
  <meta property="og:description" content="Manage your salary, income, and expenses with automatic carry-over balances. EUR to BGN conversion included.">
  <meta property="og:type" content="website">
  <meta property="og:locale" content="en_US">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Salary Tracker - Free Personal Finance Manager">
  <meta name="twitter:description" content="Track your salary and expenses with monthly carry-over balances. Secure, offline-first, no signup.">
  <title>Salary Tracker - Free Personal Expense & Income Manager</title>
  <link rel="canonical" href="https://rootdeyan.github.io/MySalaryTracker/">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75' fill='%2360a5fa'>â‚¬</text></svg>">
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Salary Tracker",
    "description": "Free personal salary and expense tracker with monthly balance carry-over",
    "url": "https://rootdeyan.github.io/MySalaryTracker/",
    "applicationCategory": "FinanceApplication",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "EUR"
    },
    "author": {
      "@type": "Organization",
      "name": "Salary Tracker"
    }
  }
  </script>
  <style>
    :root {
      --bg: #0d0d18;
      --surface: #161622;
      --text: #e2e8f0;
      --text2: #94a3b8;
      --primary: #60a5fa;
      --income: #34d399;
      --income-rgb: 52, 211, 153;
      --expense: #f87171;
      --expense-rgb: 248, 113, 113;
      --border: #2a2f45;
      --radius: 10px;
      --edit: #60a5fa;
      --delete: #f87171;
      --income-bg: rgba(52, 211, 153, 0.1);
      --expense-bg: rgba(248, 113, 113, 0.1);
    }
    [data-theme="light"] {
      --bg: #e5e7eb;
      --surface: #f3f4f6;
      --text: #111827;
      --text2: #4b5563;
      --primary: #3b82f6;
      --income: #10b981;
      --income-rgb: 16, 185, 129;
      --expense: #ef4444;
      --expense-rgb: 239, 68, 68;
      --border: #d1d5db;
      --edit: #1e40af;
      --delete: #dc2626;
      --income-bg: rgba(16, 185, 129, 0.1);
      --expense-bg: rgba(239, 68, 68, 0.1);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 12px;
      overflow-y: auto;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    .container { max-width: 720px; margin: 0 auto; }
    .theme-wrapper {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 8px;
    }
    .theme-toggle {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
      cursor: pointer;
      font-size: 0.9rem;
      width: 32px;
      height: 32px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s, transform 0.1s;
      -webkit-tap-highlight-color: transparent;
    }
    .theme-toggle:hover { background: var(--primary); color: white; transform: scale(1.05); }
    .theme-toggle:active { transform: scale(0.95); }
    header {
      margin-bottom: 1.2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    h1 { font-size: 1.6rem; font-weight: 600; letter-spacing: -0.5px; }
    .subtitle { color: var(--text2); font-size: 0.9rem; }
    .form {
      background: var(--surface);
      padding: 12px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      margin-bottom: 1.4rem;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    input, select, button {
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #1c1f32;
      color: var(--text);
      font-size: 14px;
      min-height: 36px;
      line-height: 1.2;
      transition: all 0.2s ease;
    }
    [data-theme="light"] input, [data-theme="light"] select, [data-theme="light"] button { background: #ffffff; }
    input:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(96,165,250,0.1); }
    input[type=number] { width: 100px; appearance: textfield; -moz-appearance: textfield; }
    input[type=number]::-webkit-outer-spin-button, input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[placeholder] { color: var(--text2); }
    select { min-width: 90px; }
    select option { background: var(--surface); color: var(--text); }
    button {
      background: var(--primary);
      border: none;
      color: white;
      font-weight: 600;
      cursor: pointer;
      min-width: 70px;
      -webkit-tap-highlight-color: transparent;
    }
    .button-group {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    #menu-btn {
      background: var(--border);
      color: var(--text);
      min-width: 44px;
      padding: 8px;
      font-size: 1.2rem;
    }
    #menu-btn:hover {
      background: var(--text2);
      color: white;
    }
    [data-theme="light"] button {
      color: white;
      background: var(--primary);
    }
    button:hover { opacity: 0.9; transform: translateY(-1px); }
    button:active { transform: translateY(0); }
    .income-select { background: var(--income-bg); border-color: var(--income); }
    .expense-select { background: var(--expense-bg); border-color: var(--expense); }
    .desc-field { flex: 3 1 180px; }
    .amount-field { flex: 1 1 100px; }
    .type-field { flex: 1 1 90px; }
    .month {
      background: var(--surface);
      border-radius: var(--radius);
      margin-bottom: 1.2rem;
      border: 1px solid var(--border);
      overflow: hidden;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .month-header {
      padding: 10px 14px;
      background: #1e2238;
      display: flex;
      justify-content: space-between;
      font-weight: 600;
      font-size: 1.05rem;
      border-bottom: 1px solid var(--border);
    }
    [data-theme="light"] .month-header { background: #e5e7eb; }
    .month-balance { font-variant-numeric: tabular-nums; }
    .positive { color: var(--income); }
    .negative { color: var(--expense); }
    .month-total {
      text-align: center;
      padding: 12px;
      border-bottom: 1px solid var(--border);
    }
    .total-eur {
      font-size: 1.2rem;
      font-weight: bold;
      font-variant-numeric: tabular-nums;
    }
    .total-bgn {
      font-size: 0.85rem;
      color: var(--text2);
      margin-top: 4px;
      font-variant-numeric: tabular-nums;
    }
    .transactions-list {
      max-height: 150px;
      overflow-y: auto;
      will-change: scroll-position;
    }
    .transactions-list::-webkit-scrollbar { width: 5px; }
    .transactions-list::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    [data-theme="light"] .transactions-list::-webkit-scrollbar-thumb { background: #a1a1aa; }
    .row {
      padding: 8px 14px;
      border-top: 1px solid var(--border);
      display: grid;
      gap: 10px;
      grid-template-columns: 1fr auto auto;
      align-items: flex-start;
      animation: slideIn 0.2s ease;
    }
    @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
    .desc { font-size: 0.95rem; line-height: 1.3; word-break: break-word; }
    .meta { font-size: 0.74rem; color: var(--text2); margin-top: 2px; }
    .amt { text-align: right; font-weight: 500; white-space: nowrap; font-variant-numeric: tabular-nums; }
    .income { color: var(--income); }
    .expense { color: var(--expense); }
    .bgn { font-size: 0.78rem; color: var(--text2); text-align: right; white-space: nowrap; font-variant-numeric: tabular-nums; margin-top: 2px; }
    .actions { display: flex; gap: 6px; justify-content: flex-end; align-self: flex-start; }
    .btn-small {
      background: transparent;
      border: 2px solid #444;
      width: 32px;
      height: 32px;
      border-radius: 6px;
      color: inherit;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .btn-edit { border-color: var(--edit); color: var(--edit); }
    .btn-delete { border-color: var(--delete); color: var(--delete); }
    [data-theme="light"] .btn-edit { border-color: var(--edit); color: var(--edit); background: white; }
    [data-theme="light"] .btn-delete { border-color: var(--delete); color: var(--delete); background: white; }
    .btn-edit:hover { background: rgba(96,165,250,0.2); transform: scale(1.1); }
    .btn-delete:hover { background: rgba(248,113,113,0.2); transform: scale(1.1); }
    [data-theme="light"] .btn-edit:hover { transform: scale(1.1); background: #dbeafe; border-color: var(--edit); color: var(--edit); }
    [data-theme="light"] .btn-delete:hover { transform: scale(1.1); background: #fee2e2; border-color: var(--delete); color: var(--delete); }
    .btn-small:active { transform: scale(0.95); }
    .empty-month { padding: 16px; color: var(--text2); text-align: center; font-style: italic; font-size: 0.9rem; }
    .indicator { display: none; position: fixed; bottom: 20px; right: 20px; background: var(--primary); color: white; padding: 8px 12px; border-radius: 6px; font-size: 0.85rem; z-index: 1000; }
    .indicator.show { display: block; animation: slideInUp 0.3s ease; }
    @keyframes slideInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .menu-container { position: relative; display: inline-block; }
    .menu-dropdown { 
      display: none; 
      position: absolute; 
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      min-width: 140px;
      z-index: 1001;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      top: 100%;
      right: 0;
      margin-top: 4px;
    }
    .menu-dropdown.show { display: block; }
    .menu-item {
      padding: 10px 14px;
      cursor: pointer;
      border: none;
      background: transparent;
      width: 100%;
      text-align: left;
      color: var(--text);
      font-size: 0.9rem;
      transition: background 0.2s ease;
      border: none;
    }
    .menu-item:hover { background: var(--primary); color: white; }
    .menu-item:first-child { border-radius: 7px 7px 0 0; }
    .menu-item:last-child { border-radius: 0 0 7px 7px; }
    @media (max-width: 560px) {
      body { padding: 10px; }
      .form { padding: 12px; flex-direction: column; gap: 8px; }
      input, select { width: 100%; max-height: 44px; font-size: 16px; padding: 12px; }
      .button-group { width: 100%; display: flex; gap: 8px; }
      #add { flex: 1; max-height: 44px; font-size: 16px; padding: 12px; }
      #menu-btn { flex: 0 0 auto; max-height: 44px; padding: 12px; }
      .row {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto;
        gap: 6px;
        padding: 10px 12px;
      }
      .actions { justify-content: flex-end; gap: 12px; }
      .btn-small { width: 40px; height: 40px; font-size: 1rem; }
      .amt, .bgn { text-align: left; }
    }
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; }
    }
  </style>
</head>
<body data-theme="dark">
<div class="container">
  <div class="theme-wrapper">
    <button class="theme-toggle" id="theme-toggle" title="Toggle theme">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
      </svg>
    </button>
  </div>
  <header>
    <h1>ðŸ’° Salary Tracker</h1>
  </header>
  <div class="form" role="form" aria-label="Add transaction">
    <input id="desc" class="desc-field" placeholder="Description" aria-label="Transaction description" maxlength="100">
    <input id="amount" class="amount-field" type="number" step="0.01" min="0.01" max="999999.99" placeholder="Amount" inputmode="decimal" aria-label="Transaction amount">
    <select id="type" class="type-field" aria-label="Transaction type">
      <option value="income">Income</option>
      <option value="expense">Expense</option>
    </select>
    <div class="button-group">
      <button id="add" aria-label="Add transaction">Add</button>
      <div class="menu-container">
        <button id="menu-btn" aria-label="Data backup menu">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="1"></circle>
            <circle cx="19" cy="12" r="1"></circle>
            <circle cx="5" cy="12" r="1"></circle>
          </svg>
        </button>
        <div id="menu-dropdown" class="menu-dropdown">
          <button class="menu-item" onclick="FileManager.exportToTxt()">ðŸ’¾ Download</button>
          <button class="menu-item" onclick="document.getElementById('file-input').click()">ðŸ“¤ Upload</button>
        </div>
      </div>
    </div>
    <input id="file-input" type="file" accept=".txt" style="display: none;">
  </div>
  <div id="months" role="region" aria-label="Transactions by month"></div>
  <div id="indicator" class="indicator" role="status" aria-live="polite"></div>
</div>
<script>
// Configuration & Constants
const CONFIG = {
  STORAGE_KEY: 'salary-tracker-monthly-v3',
  THEME_KEY: 'salary-tracker-theme',
  EUR_TO_BGN: 1.95583,
  MAX_DESC_LENGTH: 100,
  MAX_AMOUNT: 999999.99,
  MIN_AMOUNT: 0.01,
  RATE_LIMIT_MS: 300,
  MAX_TRANSACTIONS_PER_MONTH: 1000,
  DEBOUNCE_DELAY: 500,
  SESSION_TIMEOUT_MS: 3600000 // 1 hour
};

// State Management
const STATE = {
  months: JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEY) || '{}'),
  editing: null,
  lastActionTime: Date.now(),
  sessionId: Math.random().toString(36).substr(2, 9),
  renderTimeout: null
};

// Utility: Rate Limiting & Security
const Security = {
  checkRateLimit() {
    const now = Date.now();
    if (now - STATE.lastActionTime < CONFIG.RATE_LIMIT_MS) {
      console.warn('Rate limit exceeded');
      return false;
    }
    STATE.lastActionTime = now;
    return true;
  },
  
  validateInput(desc, amt, type) {
    if (!desc || typeof desc !== 'string') return false;
    if (desc.trim().length === 0 || desc.length > CONFIG.MAX_DESC_LENGTH) return false;
    const amount = Number(amt);
    if (isNaN(amount) || amount < CONFIG.MIN_AMOUNT || amount > CONFIG.MAX_AMOUNT) return false;
    if (!['income', 'expense'].includes(type)) return false;
    return true;
  },
  
  sanitizeInput(str) {
    if (typeof str !== 'string') return '';
    return str.slice(0, CONFIG.MAX_DESC_LENGTH)
      .replace(/[<>]/g, '')
      .trim();
  },
  
  checkDataIntegrity() {
    const txCount = Object.values(STATE.months).reduce((sum, m) => sum + (m.tx?.length || 0), 0);
    return txCount <= CONFIG.MAX_TRANSACTIONS_PER_MONTH * Object.keys(STATE.months).length;
  }
};

// Utility: Date & Formatting
const Formatter = {
  getMonthKey(d = new Date()) {
    return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
  },
  
  formatDate(timestamp) {
    try {
      return new Date(timestamp).toLocaleString('bg-BG', {
        day: '2-digit', month: '2-digit', year: 'numeric',
        hour: '2-digit', minute: '2-digit', hour12: false
      }).replace(',', '');
    } catch {
      return 'Invalid Date';
    }
  },
  
  formatCurrency(amount, currency = 'EUR') {
    return `${amount >= 0 ? '+' : ''}${Number(amount).toFixed(2)} ${currency}`;
  },
  
  convertToBGN(eur) {
    return (eur * CONFIG.EUR_TO_BGN).toFixed(2);
  }
};

// Data Management
const DataManager = {
  save() {
    if (!Security.checkDataIntegrity()) {
      console.error('Data integrity check failed');
      return false;
    }
    try {
      localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(STATE.months));
      this.showIndicator('Saved', 'success');
      return true;
    } catch (e) {
      console.error('Storage error:', e);
      this.showIndicator('Save failed', 'error');
      return false;
    }
  },
  
  getOrCreateMonth(key) {
    if (!STATE.months[key]) {
      let carry = 0;
      const [y, m] = key.split('-').map(Number);
      let py = y, pm = m - 1;
      if (pm === 0) { pm = 12; py--; }
      const pk = `${py}-${String(pm).padStart(2, '0')}`;
      if (STATE.months[pk]) {
        carry = STATE.months[pk].carry + STATE.months[pk].income - STATE.months[pk].expense;
      }
      STATE.months[key] = { income: 0, expense: 0, carry, tx: [] };
    }
    return STATE.months[key];
  },
  
  addTransaction(desc, amt, type) {
    if (!Security.validateInput(desc, amt, type) || !Security.checkRateLimit()) return false;
    
    desc = Security.sanitizeInput(desc);
    const key = Formatter.getMonthKey();
    const m = this.getOrCreateMonth(key);
    
    m.tx.unshift({ desc, amt: Number(amt), type, ts: Date.now() });
    if (type === 'income') m.income += Number(amt);
    else m.expense += Number(amt);
    
    return this.save();
  },
  
  updateTransaction(monthKey, idx, desc, amt, type) {
    if (!Security.validateInput(desc, amt, type) || !Security.checkRateLimit()) return false;
    
    desc = Security.sanitizeInput(desc);
    const m = STATE.months[monthKey];
    if (!m || !m.tx[idx]) return false;
    
    const old = m.tx[idx];
    if (old.type === 'income') m.income -= old.amt;
    else m.expense -= old.amt;
    
    m.tx[idx] = { desc, amt: Number(amt), type, ts: Date.now() };
    if (type === 'income') m.income += Number(amt);
    else m.expense += Number(amt);
    
    return this.save();
  },
  
  deleteTransaction(k, i) {
    if (!Security.checkRateLimit()) return false;
    const m = STATE.months[k];
    if (!m || !m.tx[i]) return false;
    
    const t = m.tx[i];
    if (t.type === 'income') m.income -= t.amt;
    else m.expense -= t.amt;
    
    m.tx.splice(i, 1);
    return this.save();
  },
  
  showIndicator(msg, type = 'info') {
    const ind = document.getElementById('indicator');
    if (ind) {
      ind.textContent = msg;
      ind.className = `indicator show ${type}`;
      setTimeout(() => ind.classList.remove('show'), 2000);
    }
  }
};

// UI Rendering
const UI = {
  render() {
    clearTimeout(STATE.renderTimeout);
    STATE.renderTimeout = setTimeout(() => this._doRender(), 100);
  },
  
  _doRender() {
    const c = document.getElementById('months');
    c.innerHTML = '';
    const keys = Object.keys(STATE.months).sort().reverse();
    const ck = Formatter.getMonthKey();
    
    if (!keys.includes(ck)) {
      DataManager.getOrCreateMonth(ck);
      keys.unshift(ck);
    }
    
    keys.forEach(key => {
      const m = STATE.months[key];
      const final = m.carry + m.income - m.expense;
      const isCur = key === ck;
      const mo = document.createElement('div');
      mo.className = 'month';
      
      // Header
      const h = document.createElement('div');
      h.className = 'month-header';
      h.innerHTML = `<div>${key}${isCur ? ' <small>(current)</small>' : ''}</div>`;
      
      // Total
      const totalDiv = document.createElement('div');
      totalDiv.className = 'month-total';
      const bgnTotal = Formatter.convertToBGN(final);
      totalDiv.innerHTML = `
        <div class="total-eur month-balance ${final >= 0 ? 'positive' : 'negative'}">${final.toFixed(2)} â‚¬</div>
        <div class="total-bgn">â‰ˆ ${bgnTotal} BGN</div>
      `;
      
      // Transactions
      const l = document.createElement('div');
      l.className = 'transactions-list';
      
      if (m.carry !== 0) {
        const cr = document.createElement('div');
        cr.className = 'row';
        cr.innerHTML = `<div class="desc" style="color:var(--text2)">Carry from prev</div>
          <div><div class="amt">${m.carry >= 0 ? '+' : ''}${m.carry.toFixed(2)} â‚¬</div></div><div></div>`;
        l.appendChild(cr);
      }
      
      if (m.tx.length === 0 && m.carry === 0) {
        const e = document.createElement('div');
        e.className = 'empty-month';
        e.textContent = 'No transactions this month';
        l.appendChild(e);
      } else {
        m.tx.forEach((t, i) => {
          const r = document.createElement('div');
          r.className = 'row';
          const dateStr = Formatter.formatDate(t.ts);
          const bgnAmt = Formatter.convertToBGN(t.amt);
          r.innerHTML = `
            <div>
              <div class="desc">${this.escapeHtml(t.desc)}</div>
              <div class="meta">${dateStr}</div>
            </div>
            <div>
              <div class="amt ${t.type}">${t.type === 'income' ? '+' : '-'}${Number(t.amt).toFixed(2)} â‚¬</div>
              <div class="bgn">â‰ˆ ${bgnAmt} BGN</div>
            </div>
            <div class="actions">
              <button class="btn-small btn-edit" onclick="UI.startEdit('${key}',${i})" title="Edit">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
              </button>
              <button class="btn-small btn-delete" onclick="UI.removeTx('${key}',${i})" title="Delete">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  <line x1="10" y1="11" x2="10" y2="17"></line>
                  <line x1="14" y1="11" x2="14" y2="17"></line>
                </svg>
              </button>
            </div>`;
          l.appendChild(r);
        });
      }
      
      mo.appendChild(h);
      mo.appendChild(totalDiv);
      mo.appendChild(l);
      c.appendChild(mo);
    });
    
    document.getElementById('add').textContent = STATE.editing ? 'Save Edit' : 'Add';
  },
  
  escapeHtml(text) {
    const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
    return text.replace(/[&<>"']/g, m => map[m]);
  },
  
  startEdit(monthKey, idx) {
    if (!Security.checkRateLimit()) return;
    const t = STATE.months[monthKey]?.tx[idx];
    if (!t) return;
    
    document.getElementById('desc').value = t.desc;
    document.getElementById('amount').value = t.amt;
    document.getElementById('type').value = t.type;
    this.updateTypeSelect(t.type);
    STATE.editing = { monthKey, idx };
    this.render();
  },
  
  removeTx(k, i) {
    if (!confirm('Delete this transaction?')) return;
    if (DataManager.deleteTransaction(k, i)) {
      this.clearForm();
      this.render();
    }
  },
  
  clearForm() {
    document.getElementById('desc').value = '';
    document.getElementById('amount').value = '';
    document.getElementById('type').value = 'income';
    this.updateTypeSelect('income');
    STATE.editing = null;
  },
  
  updateTypeSelect(type) {
    const sel = document.getElementById('type');
    sel.classList.remove('income-select', 'expense-select');
    sel.classList.add(`${type}-select`);
  },
  
  addTransaction() {
    const desc = document.getElementById('desc').value.trim();
    const amt = document.getElementById('amount').value;
    const type = document.getElementById('type').value;
    
    if (!desc || !amt) return;
    
    const success = STATE.editing
      ? DataManager.updateTransaction(STATE.editing.monthKey, STATE.editing.idx, desc, amt, type)
      : DataManager.addTransaction(desc, amt, type);
    
    if (success) {
      this.clearForm();
      this.render();
    }
  }
};

// Theme Management
const Theme = {
  init() {
    const currentTheme = localStorage.getItem(CONFIG.THEME_KEY) || 'dark';
    document.body.setAttribute('data-theme', currentTheme);
    this.updateToggleIcon(currentTheme);
    
    document.getElementById('theme-toggle').addEventListener('click', () => this.toggle());
    document.getElementById('type').addEventListener('change', (e) => UI.updateTypeSelect(e.target.value));
  },
  
  toggle() {
    const current = document.body.getAttribute('data-theme');
    const newTheme = current === 'dark' ? 'light' : 'dark';
    document.body.setAttribute('data-theme', newTheme);
    localStorage.setItem(CONFIG.THEME_KEY, newTheme);
    this.updateToggleIcon(newTheme);
  },
  
  updateToggleIcon(theme) {
    const btn = document.getElementById('theme-toggle');
    if (theme === 'dark') {
      btn.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="5"></circle>
          <line x1="12" y1="1" x2="12" y2="3"></line>
          <line x1="12" y1="21" x2="12" y2="23"></line>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
          <line x1="1" y1="12" x2="3" y2="12"></line>
          <line x1="21" y1="12" x2="23" y2="12"></line>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
      `;
    } else {
      btn.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
      `;
    }
  }
};

// Export/Import Management
const FileManager = {
  exportToTxt() {
    try {
      const data = STATE.months;
      let txtContent = 'SALARY TRACKER BACKUP - ' + new Date().toLocaleString() + '\n';
      txtContent += '=' .repeat(50) + '\n\n';
      
      const keys = Object.keys(data).sort();
      keys.forEach(monthKey => {
        const m = data[monthKey];
        const final = m.carry + m.income - m.expense;
        const bgnTotal = Formatter.convertToBGN(final);
        
        txtContent += `MONTH: ${monthKey}\n`;
        txtContent += '-' .repeat(40) + '\n';
        txtContent += `Carry from previous: ${m.carry.toFixed(2)} â‚¬\n`;
        txtContent += `Total Income: ${m.income.toFixed(2)} â‚¬\n`;
        txtContent += `Total Expense: ${m.expense.toFixed(2)} â‚¬\n`;
        txtContent += `Final Balance: ${final.toFixed(2)} â‚¬ (â‰ˆ ${bgnTotal} BGN)\n\n`;
        
        txtContent += 'TRANSACTIONS:\n';
        if (m.tx.length === 0) {
          txtContent += '  (No transactions)\n';
        } else {
          m.tx.forEach(t => {
            const dateStr = Formatter.formatDate(t.ts);
            const bgnAmt = Formatter.convertToBGN(t.amt);
            const sign = t.type === 'income' ? '+' : '-';
            txtContent += `  [${dateStr}] ${sign}${t.amt.toFixed(2)} â‚¬ (â‰ˆ ${bgnAmt} BGN) - ${t.type.toUpperCase()} - ${t.desc}\n`;
          });
        }
        txtContent += '\n' + '='.repeat(50) + '\n\n';
      });
      
      // Create and download file
      const blob = new Blob([txtContent], { type: 'text/plain;charset=utf-8' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      const now = new Date();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const year = String(now.getFullYear()).slice(-2);
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      link.download = `ST-${month}/${day}/${year}-${hours}.${minutes}.${seconds}.txt`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(link.href);
      
      DataManager.showIndicator('Data exported successfully', 'success');
    } catch (e) {
      console.error('Export error:', e);
      DataManager.showIndicator('Export failed', 'error');
    }
  },
  
  importFromTxt(file) {
    try {
      const reader = new FileReader();
      reader.onload = (e) => {
        const content = e.target.result;
        const importedData = this.parseTxtContent(content);
        
        if (!importedData || Object.keys(importedData).length === 0) {
          DataManager.showIndicator('Invalid file format', 'error');
          return;
        }
        
        if (confirm('This will merge the imported data with existing data. Continue?')) {
          // Merge data
          Object.keys(importedData).forEach(monthKey => {
            const imported = importedData[monthKey];
            const existing = STATE.months[monthKey];
            
            if (!existing) {
              STATE.months[monthKey] = imported;
            } else {
              // Merge transactions, avoiding duplicates based on timestamp and amount
              const existingTxs = existing.tx || [];
              const importedTxs = imported.tx || [];
              
              importedTxs.forEach(iTx => {
                const isDuplicate = existingTxs.some(eTx => 
                  eTx.ts === iTx.ts && eTx.amt === iTx.amt && eTx.type === iTx.type && eTx.desc === iTx.desc
                );
                if (!isDuplicate) {
                  existingTxs.unshift(iTx);
                  if (iTx.type === 'income') existing.income += iTx.amt;
                  else existing.expense += iTx.amt;
                }
              });
              existing.tx = existingTxs;
            }
          });
          
          DataManager.save();
          UI.render();
          DataManager.showIndicator('Data imported successfully', 'success');
        }
      };
      reader.readAsText(file);
    } catch (e) {
      console.error('Import error:', e);
      DataManager.showIndicator('Import failed', 'error');
    }
  },
  
  parseTxtContent(content) {
    try {
      const lines = content.split('\n');
      const data = {};
      let currentMonth = null;
      let currentTxs = [];
      
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        
        if (line.startsWith('MONTH:')) {
          if (currentMonth) {
            data[currentMonth] = currentTxs;
          }
          currentMonth = line.replace('MONTH:', '').trim();
          currentTxs = [];
        } else if (line.startsWith('[') && line.includes(']') && currentMonth) {
          // Parse transaction line
          const txMatch = line.match(/\[(.*?)\]\s*([\+\-])(\d+\.?\d*)\s*â‚¬.*?-\s*(INCOME|EXPENSE)\s*-\s*(.*)/i);
          if (txMatch) {
            const [, dateStr, sign, amount, type, desc] = txMatch;
            try {
              const date = new Date(dateStr);
              if (!isNaN(date.getTime())) {
                currentTxs.push({
                  desc: desc.trim(),
                  amt: parseFloat(amount),
                  type: type.toLowerCase(),
                  ts: date.getTime()
                });
              }
            } catch (e) {
              console.warn('Could not parse transaction:', line);
            }
          }
        }
      }
      
      if (currentMonth && currentTxs.length > 0) {
        data[currentMonth] = { income: 0, expense: 0, carry: 0, tx: currentTxs };
        // Recalculate totals
        currentTxs.forEach(tx => {
          if (tx.type === 'income') data[currentMonth].income += tx.amt;
          else data[currentMonth].expense += tx.amt;
        });
      }
      
      return data;
    } catch (e) {
      console.error('Parse error:', e);
      return null;
    }
  }
};

// Event Listeners
document.getElementById('add').addEventListener('click', () => UI.addTransaction());
document.getElementById('amount').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') UI.addTransaction();
});
document.getElementById('menu-btn').addEventListener('click', () => {
  const dropdown = document.getElementById('menu-dropdown');
  dropdown.classList.toggle('show');
});
document.addEventListener('click', (e) => {
  const dropdown = document.getElementById('menu-dropdown');
  const menuContainer = document.querySelector('.menu-container');
  if (!menuContainer.contains(e.target)) {
    dropdown.classList.remove('show');
  }
});
document.getElementById('file-input').addEventListener('change', (e) => {
  if (e.target.files[0]) {
    FileManager.importFromTxt(e.target.files[0]);
    e.target.value = ''; // Reset file input
  }
  document.getElementById('menu-dropdown').classList.remove('show');
});
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && STATE.editing) {
    UI.clearForm();
    UI.render();
  }
});

// Initialize
Theme.init();
UI.render();

// Service Worker for offline support (optional)
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('data:application/javascript,self.addEventListener("install",e=>self.skipWaiting());self.addEventListener("activate",e=>e.waitUntil(self.clients.matchAll().then(c=>c.forEach(client=>client.navigate(client.url)))));', { type: 'module' }).catch(() => {});
}

// Session timeout warning
setInterval(() => {
  if (Date.now() - STATE.lastActionTime > CONFIG.SESSION_TIMEOUT_MS && Object.keys(STATE.months).length > 0) {
    DataManager.showIndicator('Session may have expired - refreshing...', 'info');
    UI.render();
  }
}, 60000);
</script>
</body>
</html>
