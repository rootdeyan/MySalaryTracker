<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Salary Tracker • Monthly Carry</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    :root {
      --bg: #0d0d18;
      --surface: #161622;
      --text: #e2e8f0;
      --text2: #94a3b8;
      --primary: #60a5fa;
      --income: #34d399;
      --expense: #f87171;
      --border: #2a2f45;
      --radius: 12px;
      --edit: #60a5fa;
      --delete: #f87171;
    }
    * { box-sizing:border-box; margin:0; padding:0; }
    body {
      font-family: system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 16px;
    }
    .container { max-width: 720px; margin: 0 auto; }
    header { margin: 0 0 1.5rem; }
    h1 { font-size: 1.7rem; font-weight: 600; }
    .subtitle { color: var(--text2); font-size: 0.95rem; }
    .form {
      display: flex; flex-wrap: wrap; gap: 10px;
      background: var(--surface); padding: 14px;
      border-radius: var(--radius); border: 1px solid var(--border);
      margin-bottom: 1.8rem;
    }
    input, select, button {
      padding: 10px 12px; border-radius: 8px;
      border: 1px solid var(--border); background: #1c1f32;
      color: var(--text); font-size: 1rem;
    }
    input[type=number] { width: 140px; flex: 1 1 140px; }
    input[placeholder] { color: var(--text2); }
    select { min-width: 110px; flex: 1 1 110px; }
    button {
      background: var(--primary); border: none; color: white;
      font-weight: 600; cursor: pointer; padding: 0 16px;
    }
    .month {
      background: var(--surface); border-radius: var(--radius);
      margin-bottom: 1.4rem; border: 1px solid var(--border);
      overflow: hidden;
    }
    .month-header {
      padding: 12px 16px; background: #1e2238;
      display: flex; justify-content: space-between; font-weight: 600;
      font-size: 1.05rem; border-bottom: 1px solid var(--border);
    }
    .month-balance { font-variant-numeric: tabular-nums; }
    .positive { color: var(--income); }
    .negative { color: var(--expense); }
    .transactions-list {
      max-height: 480px;
      overflow-y: auto;
      scrollbar-width: thin;
    }
    .transactions-list::-webkit-scrollbar { width: 6px; }
    .transactions-list::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    .row {
      padding: 10px 16px; border-top: 1px solid var(--border);
      display: grid; gap: 12px;
      grid-template-columns: 1fr auto 90px;
      align-items: center;
    }
    .desc { font-size: 0.96rem; }
    .meta { font-size: 0.78rem; color: var(--text2); margin-top: 2px; }
    .amt { text-align: right; font-weight: 500; min-width: 100px; }
    .income { color: var(--income); }
    .expense { color: var(--expense); }
    .bgn { font-size: 0.82rem; color: var(--text2); text-align: right; }
    .actions { display: flex; gap: 8px; justify-content: flex-end; }
    .btn-small {
      background: transparent; border: 1px solid #444;
      font-size: 0.9rem; width: 32px; height: 32px;
      border-radius: 6px; cursor: pointer; display: inline-flex;
      align-items: center; justify-content: center; transition: 0.13s;
    }
    .btn-edit  { border-color: var(--edit);  color: var(--edit); }
    .btn-delete { border-color: var(--delete); color: var(--delete); }
    .btn-edit:hover  { background: rgba(96,165,250,0.15); color: white; }
    .btn-delete:hover { background: rgba(248,113,113,0.15); color: white; }
    .empty-month { padding: 20px; color: var(--text2); text-align: center; font-style: italic; }
    @media (max-width: 560px) {
      .form { flex-direction: column; }
      input[type=number], select { width: 100%; }
      .row { grid-template-columns: 1fr; grid-template-rows: auto auto auto; gap: 6px; }
      .actions { grid-row: 3; justify-content: flex-end; }
      .amt, .bgn { text-align: left; }
    }
  </style>
</head>
<body>

<div class="container">
  <header>
    <h1>Salary & Expense Tracker</h1>
    <div class="subtitle">Monthly balance with carry-over</div>
  </header>

  <div class="form">
    <input id="desc" placeholder="Description" style="flex:3 1 200px;">
    <input id="amount" type="number" step="0.01" min="0.01" placeholder="Amount">
    <select id="type">
      <option value="income">Income</option>
      <option value="expense">Expense</option>
    </select>
    <button id="add">Add</button>
  </div>

  <div id="months"></div>
</div>

<script>
const STORAGE_KEY = 'salary-tracker-monthly-v3';
const EUR_TO_BGN = 1.95583;

let months = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
let editing = null;

function getMonthKey(d = new Date()) {
  return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0');
}

function getOrCreateMonth(key) {
  if (!months[key]) {
    let carry = 0;
    const [y,m] = key.split('-').map(Number);
    let py=y, pm=m-1; if(pm===0){pm=12;py--;}
    const pk = `${py}-${String(pm).padStart(2,'0')}`;
    if(months[pk]) carry = months[pk].carry + months[pk].income - months[pk].expense;
    months[key] = {income:0, expense:0, carry, tx:[]};
  }
  return months[key];
}

function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(months)); }

function render() {
  const c = document.getElementById('months');
  c.innerHTML = '';
  const keys = Object.keys(months).sort().reverse();
  const ck = getMonthKey();
  if(!keys.includes(ck)){ getOrCreateMonth(ck); keys.unshift(ck); }

  keys.forEach(key => {
    const m = months[key];
    const final = m.carry + m.income - m.expense;
    const isCur = key === ck;

    const mo = document.createElement('div'); mo.className='month';
    const h = document.createElement('div'); h.className='month-header';
    h.innerHTML = `<div>${key}${isCur?' <small>(current)</small>':''}</div>
      <div class="month-balance ${final>=0?'positive':'negative'}">${final.toFixed(2)} €</div>`;

    const l = document.createElement('div');
    l.className = 'transactions-list';

    if (m.carry !== 0) {
      const cr = document.createElement('div'); cr.className='row';
      cr.innerHTML = `<div class="desc" style="color:var(--text2)">Carry from prev</div>
        <div class="amt">${m.carry>=0?'+':''}${m.carry.toFixed(2)} €</div><div></div>`;
      l.appendChild(cr);
    }

    if (m.tx.length === 0 && m.carry === 0) {
      const e = document.createElement('div'); e.className='empty-month';
      e.textContent = 'No transactions this month';
      l.appendChild(e);
    } else {
      m.tx.forEach((t,i) => {
        const r = document.createElement('div'); r.className='row';
        const dateStr = new Date(t.ts).toLocaleString('bg-BG', {
          day: '2-digit', month: '2-digit', year: 'numeric',
          hour: '2-digit', minute: '2-digit', hour12: false
        }).replace(',', '');
        const bgnAmt = (t.amt * EUR_TO_BGN).toFixed(2);
        r.innerHTML = `
          <div>
            <div class="desc">${t.desc}</div>
            <div class="meta">${dateStr}</div>
          </div>
          <div>
            <div class="amt ${t.type}">${t.type==='income'?'+':'-'}${Number(t.amt).toFixed(2)} €</div>
            <div class="bgn">≈ ${bgnAmt} BGN</div>
          </div>
          <div class="actions">
            <button class="btn-small btn-edit" onclick="startEdit('${key}',${i})"><i class="fa-solid fa-pencil"></i></button>
            <button class="btn-small btn-delete" onclick="removeTx('${key}',${i})"><i class="fa-solid fa-trash"></i></button>
          </div>`;
        l.appendChild(r);
      });
    }

    mo.appendChild(h); mo.appendChild(l); c.appendChild(mo);
  });

  document.getElementById('add').textContent = editing ? 'Save Edit' : 'Add';
}

function startEdit(monthKey, idx) {
  const t = months[monthKey].tx[idx];
  document.getElementById('desc').value = t.desc;
  document.getElementById('amount').value = t.amt;
  document.getElementById('type').value = t.type;
  editing = {monthKey, idx};
  render();
}

function addTx() {
  const desc = document.getElementById('desc').value.trim();
  const amt = Number(document.getElementById('amount').value);
  const type = document.getElementById('type').value;

  if (!desc || isNaN(amt) || amt <= 0) return;

  const key = getMonthKey();
  const m = getOrCreateMonth(key);

  if (editing) {
    const old = months[editing.monthKey].tx[editing.idx];
    if (old.type === 'income') months[editing.monthKey].income -= old.amt;
    else months[editing.monthKey].expense -= old.amt;

    months[editing.monthKey].tx[editing.idx] = {desc, amt, type, ts: Date.now()};

    if (type === 'income') months[editing.monthKey].income += amt;
    else months[editing.monthKey].expense += amt;

    editing = null;
  } else {
    m.tx.push({desc, amt, type, ts: Date.now()});
    if (type === 'income') m.income += amt;
    else m.expense += amt;
  }

  save();
  document.getElementById('desc').value = '';
  document.getElementById('amount').value = '';
  document.getElementById('type').value = 'income';
  render();
}

function removeTx(k, i){
  if(!confirm('Delete?')) return;
  const m = months[k];
  const t = m.tx[i];
  if(t.type==='income') m.income -= t.amt; else m.expense -= t.amt;
  m.tx.splice(i,1);
  save();
  render();
}

document.getElementById('add').onclick = addTx;
document.getElementById('amount').onkeydown = e => { if(e.key==='Enter') addTx(); };

document.addEventListener('keydown', e => {
  if (e.key === 'Escape' && editing) {
    editing = null;
    document.getElementById('desc').value = '';
    document.getElementById('amount').value = '';
    document.getElementById('type').value = 'income';
    render();
  }
});

render();
</script>
</body>
</html>